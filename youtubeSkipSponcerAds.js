// @license      LGPL-3.0-or-later
var lastKnownVideoTime,waitingMutationObserver,waitingElements,video,__assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)},__awaiter=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))(function(r,o){function s(e){try{a(i.next(e))}catch(t){o(t)}}function u(e){try{a(i.throw(e))}catch(t){o(t)}}function a(e){var t;e.done?r(e.value):((t=e.value)instanceof n?t:new n(function(e){e(t)})).then(s,u)}a((i=i.apply(e,t||[])).next())})},__generator=this&&this.__generator||function(e,t){var n,i,r,o,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function u(o){return function(u){return function o(u){if(n)throw TypeError("Generator is already executing.");for(;s;)try{if(n=1,i&&(r=2&u[0]?i.return:u[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,u[1])).done)return r;switch(i=0,r&&(u=[2&u[0],r.value]),u[0]){case 0:case 1:r=u;break;case 4:return s.label++,{value:u[1],done:!1};case 5:s.label++,i=u[1],u=[0];continue;case 7:u=s.ops.pop(),s.trys.pop();continue;default:if(!(r=(r=s.trys).length>0&&r[r.length-1])&&(6===u[0]||2===u[0])){s=0;continue}if(3===u[0]&&(!r||u[1]>r[0]&&u[1]<r[3])){s.label=u[1];break}if(6===u[0]&&s.label<r[1]){s.label=r[1],r=u;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(u);break}r[2]&&s.ops.pop(),s.trys.pop();continue}u=t.call(e,s)}catch(a){u=[6,a],i=0}finally{n=r=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([o,u])}}},API_URL="https://sponsor.ajay.app/api/skipSegments/",USER_AGENT_QUERY="userAgent",CATEGORY_QUERY="category",CATEGORIES=["sponsor","intro"],ActionType={Skip:"skip",Mute:"mute",Full:"full",Poi:"poi"},sponsorDataFound=!1,sponsorTimes=null,sponsorVideoID=null,sponsorSkipped=[],sponsorTimesSubmitting=[],lastTimeFromWaitingEvent=null,switchingVideos=null,firstEvent=!1,lastCheckTime=0,lastCheckVideoTime=-1,videosWithEventListeners=[],currentSkipSchedule=null,currentSkipInterval=null,isAdPlaying=!1,videoMuted=!1,videoMutationObserver=null,isSafari=!0,waitForElement=function(e){return __awaiter(void 0,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,new Promise(function(t){waitingElements.push({selector:e,callback:t}),waitingMutationObserver||(waitingMutationObserver=new MutationObserver(function(){for(var e=[],t=0,n=waitingElements;t<n.length;t++){var i=n[t],r=i.selector,o=i.callback,s=document.querySelector(r);s&&(o(s),e.push(r))}0===(waitingElements=waitingElements.filter(function(t){return!e.includes(t.selector)})).length&&(waitingMutationObserver.disconnect(),waitingMutationObserver=null)})).observe(document.body,{childList:!0,subtree:!0})})];case 1:return[2,t.sent()]}})})},isVisible=function(e){return e&&e.offsetWidth>0&&e.offsetHeight>0},findValidElement=function(e){for(var t=0,n=e;t<n.length;t++){var i=n[t];if(i&&isVisible(i))return i}return null},refreshVideoAttachments=function(){var e=findValidElement(document.querySelectorAll("video"));e&&e!==video&&(video=e,videosWithEventListeners.includes(video)||(videosWithEventListeners.push(video),setupVideoListeners()))},addPageListeners=function(){var e=function(){isVisible(video)||refreshVideoAttachments()};document.addEventListener("yt-navigate-finish",e)},skipToTime=function(e){var t=e.v,n=e.skipTime,i=e.skippingSegments;if(t.currentTime!==n[1])switch(i[0].actionType){case ActionType.Poi:case ActionType.Skip:if(t.loop&&t.duration>1&&n[1]>=t.duration-1)t.currentTime=0;else if("Apple Computer, Inc."===navigator.vendor&&t.duration>1&&n[1]>=t.duration)t.currentTime=t.duration-.001;else{try{var r=parseInt(n[1]-n[0]);GM.notification({text:"".concat(r," second(s) skipped with SponsorBlock via Hyperweb"),position:"bottom",style:"bar",timeout:5e3})}catch(o){}t.currentTime=n[1]}break;case ActionType.Mute:t.muted||(t.muted=!0,videoMuted=!0)}},updateVirtualTime=function(){lastKnownVideoTime={videoTime:video.currentTime,preciseTime:performance.now()}},updateAdFlag=function(){isAdPlaying=document.getElementsByClassName("ad-showing").length>0},cancelSponsorSchedule=function(){null!==currentSkipSchedule&&(clearTimeout(currentSkipSchedule),currentSkipSchedule=null),null!==currentSkipInterval&&(clearInterval(currentSkipInterval),currentSkipInterval=null)},inMuteSegment=function(e){var t=function(t){return t.actionType===ActionType.Mute&&t.segment[0]<=e&&t.segment[1]>e};return null==sponsorTimes?void 0:sponsorTimes.some(t)},incorrectVideoCheck=function(e,t){void 0===e&&(e=null),void 0===t&&(t=null);var n=getYouTubeVideoID(document);return!(n===(e||sponsorVideoID)&&(!t||sponsorTimes&&(null==sponsorTimes?void 0:sponsorTimes.some(function(e){return e.segment===t.segment}))||sponsorTimesSubmitting.some(function(e){return e.segment===t.segment})))&&(console.error("[SponsorBlock] The videoID recorded when trying to skip is different than what it should be."),console.error("[SponsorBlock] VideoID recorded: "+sponsorVideoID+". Actual VideoID: "+n),videoIDChange(n),!0)},getLatestEndTimeIndex=function(e,t,n){if(void 0===n&&(n=!0),-1==t||e[t].actionType!==ActionType.Skip)return t;for(var i=t,r=0;r<(null==e?void 0:e.length);r++){var o=e[r].segment,s=e[i].segment[1];o[0]<=s&&o[1]>s&&e[r].actionType===ActionType.Skip&&(i=r)}return i!==t&&(i=getLatestEndTimeIndex(e,i,n)),i},getStartTimes=function(e,t,n,i,r,o){if(void 0===i&&(i=void 0),void 0===r&&(r=!1),void 0===o&&(o=!1),!e)return{includedTimes:[],scheduledTimes:[]};var s=[],u=[],a=e.map(function(e){return __assign(__assign({},e),{scheduledTime:e.segment[0]})});e.filter(function(e){return e.actionType===ActionType.Mute}).forEach(function(e){a.some(function(t){return e.segment[1]===t.scheduledTime})||a.push(__assign(__assign({},e),{scheduledTime:e.segment[1]}))});for(var d=0;d<a.length;d++)(void 0===i||n&&a[d].scheduledTime>=i||t&&a[d].scheduledTime<i&&a[d].segment[1]>i)&&!o&&a[d].actionType!==ActionType.Poi&&(u.push(a[d].scheduledTime),s.push(a[d]));return{includedTimes:s,scheduledTimes:u}},getNextSkipIndex=function(e,t,n){var i=getStartTimes(sponsorTimes,t,n),r=i.includedTimes,o=i.scheduledTimes,s=getStartTimes(sponsorTimes,t,n,e,!0,!1).scheduledTimes,u=o.indexOf(Math.min.apply(Math,s)),a=getLatestEndTimeIndex(r,u),d=getStartTimes(sponsorTimesSubmitting,t,n),c=d.includedTimes,l=d.scheduledTimes,m=getStartTimes(sponsorTimesSubmitting,t,n,e,!1,!1).scheduledTimes,v=l.indexOf(Math.min.apply(Math,m)),p=getLatestEndTimeIndex(c,v);return -1===v&&-1!==u||o[u]<l[v]?{array:r,index:u,endIndex:a,openNotice:!0}:{array:c,index:v,endIndex:p,openNotice:!1}},startSponsorSchedule=function(e,t,n){if(void 0===e&&(e=!1),void 0===t&&(t=null),void 0===n&&(n=!0),cancelSponsorSchedule(),isAdPlaying){lastCheckVideoTime=-1,lastCheckTime=0;return}if(video&&!video.paused){if(null==t){var i=null!=lastTimeFromWaitingEvent?lastTimeFromWaitingEvent:(null==lastKnownVideoTime?void 0:lastKnownVideoTime.videoTime)?(performance.now()-lastKnownVideoTime.preciseTime)/1e3+lastKnownVideoTime.videoTime:null;t=!isSafari&&i&&.6>Math.abs(i-video.currentTime)?i:video.currentTime}if(lastTimeFromWaitingEvent=null,videoMuted&&!inMuteSegment(t)&&(video.muted=!1,videoMuted=!1),!incorrectVideoCheck()){var r=getNextSkipIndex(t,e,n);if(-1!==r.index){var o=r.array[r.index],s=[o.scheduledTime,r.array[r.endIndex].segment[1],],u=s[0]-t,a=sponsorVideoID,d=[r.array[r.index]];if(r.index!==r.endIndex){d=[];for(var c=0,l=r.array;c<l.length;c++){var m=l[c];m.segment[0]>=s[0]&&m.segment[1]<=s[1]&&d.push(m)}}var v=function(e){var t=null,n=!1,i=!0;incorrectVideoCheck(a,o)||(e||(e=video.currentTime),e>=s[0]&&e<s[1]&&(skipToTime({v:video,skipTime:s,skippingSegments:d}),o.actionType===ActionType.Mute?t=s[0]+.001:(t=s[1],n=!0,i=!1)),startSponsorSchedule(n,t,i))};if(u<.003)v(t);else{var p=1e3*u*(1/video.playbackRate);if(p<300){var h=performance.now(),$=Math.max(t,video.currentTime);currentSkipInterval=setInterval(function(){var e=performance.now()-h;(e>=p||video.currentTime>=s[0])&&(clearInterval(currentSkipInterval),video.muted||(video.muted=!0,video.muted=!1),v(Math.max(video.currentTime,$+video.playbackRate*e/1e3)))},1)}else currentSkipSchedule=setTimeout(v,Math.max(0,p-100))}}}}},durationChangeListener=function(){updateAdFlag()},setupVideoListeners=function(){video.addEventListener("durationchange",durationChangeListener),switchingVideos=!1,video.addEventListener("play",function(){(firstEvent||0!==video.currentTime)&&(firstEvent=!1,updateVirtualTime(),switchingVideos&&(switchingVideos=!1,sponsorTimes&&startSkipScheduleCheckingForStartSponsors()),updateAdFlag(),(Math.abs(lastCheckVideoTime-video.currentTime)>.3||lastCheckVideoTime!==video.currentTime&&Date.now()-lastCheckTime>2e3)&&(lastCheckTime=Date.now(),lastCheckVideoTime=video.currentTime,startSponsorSchedule()))}),video.addEventListener("playing",function(){updateVirtualTime(),(Math.abs(lastCheckVideoTime-video.currentTime)>.3||lastCheckVideoTime!==video.currentTime&&Date.now()-lastCheckTime>2e3)&&(lastCheckTime=Date.now(),lastCheckVideoTime=video.currentTime,startSponsorSchedule())}),video.addEventListener("seeking",function(){video.paused||(lastCheckTime=Date.now(),lastCheckVideoTime=video.currentTime,updateVirtualTime(),lastTimeFromWaitingEvent=null,startSponsorSchedule())}),video.addEventListener("ratechange",function(){return startSponsorSchedule()}),video.addEventListener("videoSpeed_ratechange",function(){return startSponsorSchedule()});var e=function(){lastCheckVideoTime=-1,lastCheckTime=0,lastKnownVideoTime={videoTime:null,preciseTime:null},lastTimeFromWaitingEvent=video.currentTime,cancelSponsorSchedule()};video.addEventListener("pause",e),video.addEventListener("waiting",e),startSponsorSchedule()},getYouTubeVideoID=function(e){var t=e.URL;return!t.includes("youtube.com/clip/")&&(t.includes("/embed/")&&t.includes("youtube.com")?getYouTubeVideoIDFromDocument(e,!1):!t.includes("youtube.com")||t.includes("/watch")||t.includes("/shorts/")||t.includes("playlist")?getYouTubeVideoIDFromURL(t):t.includes("/channel/")||t.includes("/user/")||t.includes("/c/")?getYouTubeVideoIDFromDocument(e):getYouTubeVideoIDFromURL(t)||getYouTubeVideoIDFromDocument(e,!1))},getYouTubeVideoIDFromDocument=function(e,t){void 0===t&&(t=!0);var n,i=null===(n=e.querySelector('[data-sessionlink="feature=player-title"]'))||void 0===n?void 0:n.getAttribute("href");return!!i&&getYouTubeVideoIDFromURL(i)},getYouTubeVideoIDFromURL=function(e){e.startsWith("https://www.youtube.com/tv#/")&&(e=e.replace("#",""));var t=null;try{t=new URL(e)}catch(n){return console.error("[SB] Unable to parse URL: "+e),!1}if(!["m.youtube.com","www.youtube.com","www.youtube-nocookie.com","music.youtube.com",].includes(t.host))return!1;if(t.searchParams.has("v")&&["/watch","/watch/"].includes(t.pathname)||t.pathname.startsWith("/tv/watch")){var i=t.searchParams.get("v");return 11==i.length&&i}if(t.pathname.startsWith("/embed/")||t.pathname.startsWith("/shorts/"))try{var i=t.pathname.split("/")[2];if((null==i?void 0:i.length)>=11)return i.slice(0,11)}catch(r){console.error("[SB] Video ID not valid for "+e)}return!1},resetValues=function(){lastCheckTime=0,lastCheckVideoTime=-1,sponsorTimes=null,sponsorSkipped=[],switchingVideos=null!==switchingVideos,firstEvent=!0,isAdPlaying=!1},setupVideoMutationListener=function(){var e=document.querySelector(".html5-video-container");e&&null===videoMutationObserver&&(videoMutationObserver=new MutationObserver(refreshVideoAttachments)).observe(e,{attributes:!0,childList:!0,subtree:!0})},getHashParams=function(){var e=window.location.hash.slice(1);return e?e.split("&").reduce(function(e,t){var n=t.split("="),i=n[0],r=n[1],o=decodeURIComponent(r);try{e[i]=(null==o?void 0:o.match(/{|\[/))?JSON.parse(o):r}catch(s){console.error("Failed to parse hash parameter ".concat(i,": ").concat(r))}return e},{}):{}},getHash=function(e,t){return void 0===t&&(t=5e3),__awaiter(void 0,void 0,void 0,function(){var n,i,r,o;return __generator(this,function(s){switch(s.label){case 0:if(t<=0)return[2,""];n=e,i=0,s.label=1;case 1:if(!(i<t))return[3,4];return[4,crypto.subtle.digest("SHA-256",new TextEncoder().encode(n).buffer)];case 2:r=s.sent(),n=(o=Array.from(new Uint8Array(r))).map(function(e){return e.toString(16).padStart(2,"0")}).join(""),s.label=3;case 3:return i++,[3,1];case 4:return[2,n]}})})},urlTimeToSeconds=function(e){if(!e)return 0;var t,n,i,r=/(?:(\d{1,3})h)?(?:(\d{1,2})m)?(\d+)s?/.exec(e);if(r){var o=parseInt(null!==(t=r[1])&&void 0!==t?t:"0",10),s=parseInt(null!==(n=r[2])&&void 0!==n?n:"0",10),u=parseInt(null!==(i=r[3])&&void 0!==i?i:"0",10);return 3600*o+60*s+u}if(/\d+/.test(e))return parseInt(e,10)},getStartTimeFromUrl=function(e){var t=new URLSearchParams(e);return urlTimeToSeconds((null==t?void 0:t.get("t"))||(null==t?void 0:t.get("time_continue")))},startSkipScheduleCheckingForStartSponsors=function(){if((!switchingVideos||isSafari)&&sponsorTimes){for(var e=getStartTimeFromUrl(document.URL)||-1,t=!1,n=null,i=0,r=sponsorTimes;i<r.length;i++){var o=r[i];if(o.segment[0]<=video.currentTime&&o.segment[0]>e&&o.segment[1]>video.currentTime&&o.actionType!==ActionType.Poi){e=o.segment[0],n=o,t=!0;break}}if(!t)for(var s=0,u=sponsorTimesSubmitting;s<u.length;s++){var o=u[s];if(o.segment[0]<=video.currentTime&&o.segment[0]>e&&o.segment[1]>video.currentTime&&o.actionType!==ActionType.Poi){e=o.segment[0],n=o,t=!0;break}}for(var a=sponsorTimes.filter(function(e){return e.segment[1]>video.currentTime&&e.actionType===ActionType.Poi}).sort(function(e,t){return t.segment[0]-e.segment[0]}),d=0,c=a;d<c.length;d++){var o=c[d];skipToTime({v:video,skipTime:o.segment,skippingSegments:[o]})}startSponsorSchedule()}},retryFetch=function(){sponsorDataFound=!1,setTimeout(function(){sponsorVideoID&&(null==sponsorTimes?void 0:sponsorTimes.length)===0&&sponsorsLookup()},1e4+3e4*Math.random())},sponsorsLookup=function(e){return void 0===e&&(e=!0),__awaiter(void 0,void 0,void 0,function(){var t,n,i,r,o,s,u,a,d,c;return __generator(this,function(l){switch(l.label){case 0:if(video&&isVisible(video)||refreshVideoAttachments(),!video)return setTimeout(function(){return sponsorsLookup()},100),[2];return setupVideoMutationListener(),[4,getVideoSegments()];case 1:if(!(null==(t=l.sent())?void 0:t.ok))return[3,3];return[4,t.json()];case 2:if(!(n=null===(c=null===(d=l.sent())||void 0===d?void 0:d.filter(function(e){return e.videoID===sponsorVideoID}))||void 0===c?void 0:c.map(function(e){return e.segments})[0])||!n.length)return retryFetch(),[2];if(sponsorDataFound=!0,null!==sponsorTimes&&e)for(i=0;i<sponsorTimes.length;i++)sponsorTimes[i].source,SponsorSourceType.Local;if(r=sponsorTimes||[],sponsorTimes=n,e)for(s=0,o=function(e){var t=sponsorTimes.find(function(t){return e.UUID===t.UUID});t&&(t.hidden=e.hidden,t.category=e.category)},u=r;s<u.length;s++)o(a=u[s]);return startSkipScheduleCheckingForStartSponsors(),[3,4];case 3:(null==t?void 0:t.status)===404&&retryFetch(),l.label=4;case 4:return Config.config.isVip&&lockedCategoriesLookup(),[2]}})})},videoIDChange=function(e){return __awaiter(void 0,void 0,void 0,function(){return __generator(this,function(t){return sponsorVideoID===e&&(isVisible(video)||!video)||(sponsorVideoID=e,resetValues(),e&&sponsorsLookup(e)),[2]})})},getVideoSegments=function(){return __awaiter(void 0,void 0,void 0,function(){var e,t,n,i;return __generator(this,function(r){switch(r.label){case 0:return[4,getHash(sponsorVideoID,1)];case 1:e=r.sent().slice(0,4),(t=new URL(API_URL+e)).searchParams.append(USER_AGENT_QUERY,window.navigator.userAgent),CATEGORIES.forEach(function(e){return t.searchParams.append(CATEGORY_QUERY,e)}),(n=getHashParams()).requiredSegment&&t.searchParams.append("requiredSegment",n.requiredSegment),r.label=2;case 2:return r.trys.push([2,4,,5]),[4,fetch(t.href)];case 3:return[2,r.sent()];case 4:return i=r.sent(),console.log("Error fetching segments for video"),[2,[]];case 5:return[2]}})})},run=function(){return __awaiter(void 0,void 0,void 0,function(){var e;return __generator(this,function(t){return waitForElement(".ytp-inline-preview-ui").then(function(){refreshVideoAttachments()}),(e=getYouTubeVideoID(document))&&sponsorsLookup(),[2]})})};videoIDChange(getYouTubeVideoID(document)),addPageListeners(),run();
